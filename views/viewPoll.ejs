<!-- views/viewPoll.ejs -->
<!doctype html>
<html lang = "en">
<head>
    <title>FCC Voting App</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css"> <!-- load bootstrap css -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css"> <!-- load fontawesome -->
		<script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
		<style>
			body {
				margin-bottom: 20px;
			}
		</style>
</head>
<body>
<nav class="navbar navbar-inverse">
	<div class="container-fluid">
		<div class="navbar-header">
			<a class="navbar-brand" href='/'>FCC Voting App</a>
		</div>
		<ul class="nav navbar-nav navbar-right">
		<% if(user) { %>
					<li><a href='/profile'><span class="glyphicon glyphicon-user"></span>
					<% if(user.firstname) { %>
						<%= user.firstname %>
					<% } else { %>
						<%= user.local.email %>
					<% } %>
					</a></li>
			<li><a href='/logout'><span class="glyphicon glyphicon-log-out"></span>Logout</a><li>
		
		<% } else { %> 
			<li><a href='/login'><span class="glypicon glyphicon-log-in"></span>Login</a></li>
			<li><a href='/signup'><span class="glyphicon glyphicon-plus-sign"></span>Signup</a></li>
		<% } %>
		</ul>
	</div>
</nav>

<div class="container">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>

	<div class="col-sm-6 col-offset-sm-3">
<% if(poll) { %>
	<h1><%= poll.title %></h1>
<canvas id="myChart" width="400" height="400"></canvas>
<script>
var ctx = document.getElementById("myChart");
var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: [ <% for(var i = 0;i<poll.options.length;i++) { %> '<%=poll.options[i].opt %>', <%}%>],
        datasets: [{
            label: '# of Votes',
            data: [<% for(var i = 0;i<poll.options.length;i++) { %> <%=poll.options[i].count %>, <%}%>],
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero:true
                }
            }]
        }
    }
});
</script>		
		<form action='/viewPoll/<%= poll.id %>' method='post'>
			<% for(var i = 0;i<poll.options.length;i++) { %>
			<div class="radio">
				<label><input type="radio" name="voteOpt" value='<%=i%>'><%=poll.options[i].opt%></label>
			</div>
			<% } %>
			<button type='button' class='btn btn-lg btn-primary' id='voteButton'>Vote</button>
		</form>
<% } else { %>
	<h1>Error loading poll!!</h1>
<% } %>
	</div>
</div>
<script>
	$(document).ready(function() {
		$('#voteButton').click(function() {
			$.post('/api/vote', {
				'pollId' : '<%=poll._id %>',
				'userId' : '<% if(user) {%> <%=user._id %> <% } else { %> IP <% } %>',
				'opt'		 : $('input[type="radio"]:checked').val()
			}, function(res) {
				if(res.success) {
					myChart.data.datasets[0].data[parseInt($('input[type="radio"]:checked').val())]++;
					myChart.update();
				}
			});
		});
	});
</script>
</body>
</html>